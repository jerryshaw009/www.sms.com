<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Auditorium Bookings - IKD</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Eras Medium ITC', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      direction: ltr;
      text-align: left;
      min-height: 100vh;
      color: #2d3748;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .title {
      background: linear-gradient(to right, #ffffff, #e0f7fa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    .slot-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-left: 4px solid;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    .slot-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .slot-card.auditorium {
      border-left-color: #3b82f6;
    }
    .slot-card.meeting {
      border-left-color: #8b5cf6;
    }
    .today-badge {
      background: linear-gradient(45deg, #ef4444, #f97316);
      color: white;
    }
    .advance-badge {
      background: linear-gradient(45deg, #10b981, #059669);
      color: white;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-today {
      background: linear-gradient(45deg, #ef4444, #f97316);
      color: white;
    }
    .btn-today:hover {
      background: linear-gradient(45deg, #dc2626, #ea580c);
    }
    .btn-advance {
      background: linear-gradient(45deg, #10b981, #059669);
      color: white;
    }
    .btn-advance:hover {
      background: linear-gradient(45deg, #059669, #047857);
    }
    .btn-all {
      background: linear-gradient(45deg, #3b82f6, #1d4ed8);
      color: white;
    }
    .btn-all:hover {
      background: linear-gradient(45deg, #2563eb, #1e40af);
    }
    .btn-print {
      background: linear-gradient(45deg, #8b5cf6, #7c3aed);
      color: white;
    }
    .btn-print:hover {
      background: linear-gradient(45deg, #7c3aed, #6d28d9);
    }
    .btn-request {
      background: linear-gradient(45deg, #f59e0b, #d97706);
      color: white;
    }
    .btn-request:hover {
      background: linear-gradient(45deg, #d97706, #b45309);
    }
    .btn-export {
      background: linear-gradient(45deg, #8b5cf6, #7c3aed);
      color: white;
    }
    .btn-export:hover {
      background: linear-gradient(45deg, #7c3aed, #6d28d9);
    }
    
    .traffic-light-card {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-left: 4px solid #3b82f6;
    }
    .time-slot {
      padding: 8px 12px;
      border-radius: 8px;
      margin: 4px 0;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .time-slot.available {
      background: #d1fae5;
      color: #065f46;
      border: 2px solid #10b981;
    }
    .time-slot.booked {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #ef4444;
    }
    .time-slot.partial {
      background: #fef3c7;
      color: #92400e;
      border: 2px solid #f59e0b;
    }
    .availability-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
    }
    .badge-available {
      background: #10b981;
      color: white;
    }
    .badge-booked {
      background: #ef4444;
      color: white;
    }
    .badge-partial {
      background: #f59e0b;
      color: white;
    }
    .venue-section {
      padding: 1rem;
      border-radius: 0.75rem;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid #e2e8f0;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 2rem;
      border-radius: 1rem;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    
    @media (max-width: 768px) {
      .mobile-padding {
        padding: 1rem;
      }
      .mobile-text-lg {
        font-size: 1.5rem;
      }
      .mobile-text-xl {
        font-size: 1.75rem;
      }
      .mobile-stack {
        flex-direction: column;
      }
      .mobile-center {
        text-align: center;
      }
      .modal-content {
        margin: 10% auto;
        width: 95%;
        padding: 1.5rem;
      }
    }
    @media print {
      body * { visibility: hidden; }
      #printSection, #printSection * { visibility: visible; }
      #printSection { position: absolute; left: 0; top: 0; width: 100%; }
      button, input, select { display: none !important; }
    }
    
    #loginModal .modal-content {
      max-width: 400px;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="p-2 md:p-4 mobile-padding">
  <!-- Login Modal -->
  <div id="loginModal" class="modal" style="display: block;">
    <div class="modal-content">
      <h2 class="text-2xl font-bold mb-4 text-center">üîí Access Required</h2>
      <p class="text-gray-600 mb-4 text-center">Enter credentials to view bookings</p>
      
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-gray-700 mb-2">Username:</label>
          <input type="text" id="username" required class="w-full border p-2 rounded" placeholder="Enter username" />
        </div>
        <div>
          <label class="block text-gray-700 mb-2">Password:</label>
          <input type="password" id="password" required class="w-full border p-2 rounded" placeholder="Enter password" />
        </div>
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 w-full">
          <i class="fas fa-sign-in-alt mr-2"></i>Login
        </button>
      </form>
      
      <p id="loginError" class="mt-4 text-red-600 text-center hidden">Invalid credentials!</p>
    </div>
  </div>

  <!-- Admin User Management Modal -->
  <div id="adminModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAdminModal()">&times;</span>
      <h2 class="text-2xl font-bold mb-4">üë®‚Äçüíº User Management</h2>
      
      <div class="mb-6">
        <h3 class="text-lg font-semibold mb-3">Add New User</h3>
        <form id="addUserForm" class="space-y-3">
          <input type="text" id="newUsername" required class="w-full border p-2 rounded" placeholder="Username" />
          <input type="password" id="newPassword" required class="w-full border p-2 rounded" placeholder="Password" />
          <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 w-full">
            <i class="fas fa-user-plus mr-2"></i>Add User
          </button>
        </form>
      </div>

      <div>
        <h3 class="text-lg font-semibold mb-3">Existing Users</h3>
        <div id="usersList" class="space-y-2 max-h-60 overflow-y-auto">
          <!-- Users list will load here -->
        </div>
      </div>
    </div>
  </div>

  <p id="currentDate" class="text-right text-white text-xs md:text-sm mb-3 md:mb-4 font-medium drop-shadow mobile-center md:text-right"></p>

  <!-- Header with Logo -->
  <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 md:mb-8 mobile-stack space-y-4 md:space-y-0">
    <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4 mobile-center">
      <img id="logoPreview" src="https://via.placeholder.com/64/ffffff/667eea?text=IKD" alt="IKD Logo" class="h-12 md:h-16 rounded-lg shadow-lg border-2 border-white bg-white p-1" />
      <div class="text-center sm:text-left">
        <h1 class="text-2xl sm:text-3xl md:text-4xl title drop-shadow-sm mobile-text-xl">Slot Reservation System - IKD</h1>
        <p id="connectionStatus" class="text-white mt-1 text-sm md:text-base font-medium opacity-90">Connecting to database...</p>
      </div>
    </div>
    <div class="flex justify-center md:justify-end">
      <button onclick="openAdminModal()" class="bg-blue-600 text-white px-4 py-2 md:px-4 md:py-2 rounded-lg mr-2 hidden" id="adminBtn">
        <i class="fas fa-users-cog mr-2"></i>Admin
      </button>
      <button onclick="openRequestModal()" class="btn-request text-white px-4 py-2 md:px-6 md:py-3 rounded-lg transition shadow-lg font-semibold text-sm md:text-base">
        <i class="fas fa-plus mr-2"></i>Request Slot
      </button>
      <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 md:px-4 md:py-2 rounded-lg ml-2">
        <i class="fas fa-sign-out-alt mr-2"></i>Logout
      </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-6 md:mb-8">
    <div class="stat-card p-4 md:p-6 text-center rounded-xl shadow-lg">
      <div class="text-2xl md:text-3xl font-bold text-white mb-2" id="totalSlots">0</div>
      <div class="text-white opacity-90 text-sm md:text-base">Total Bookings</div>
      <i class="fas fa-calendar-check text-white text-lg md:text-xl mt-2 opacity-80"></i>
    </div>
    <div class="stat-card p-4 md:p-6 text-center rounded-xl shadow-lg">
      <div class="text-2xl md:text-3xl font-bold text-white mb-2" id="todaySlots">0</div>
      <div class="text-white opacity-90 text-sm md:text-base">Today's Bookings</div>
      <i class="fas fa-clock text-white text-lg md:text-xl mt-2 opacity-80"></i>
    </div>
    <div class="stat-card p-4 md:p-6 text-center rounded-xl shadow-lg">
      <div class="text-2xl md:text-3xl font-bold text-white mb-2" id="advanceSlots">0</div>
      <div class="text-white opacity-90 text-sm md:text-base">Advance Bookings</div>
      <i class="fas fa-calendar-day text-white text-lg md:text-xl mt-2 opacity-80"></i>
    </div>
  </div>

  <!-- Venue-wise Traffic Light Availability Card -->
  <div class="glass-card p-4 md:p-6 mb-6 md:mb-8 traffic-light-card">
    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-4 md:mb-6">
      <div class="text-center lg:text-left mb-4 lg:mb-0">
        <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800 flex items-center justify-center lg:justify-start">
          <i class="fas fa-traffic-light mr-3 text-green-500"></i>Venue-wise Availability Status
        </h2>
        <p class="text-gray-600 mt-1 text-sm md:text-base">Real-time view of available time slots (8:00 AM - 4:00 PM)</p>
      </div>
      <div class="flex justify-center lg:justify-end space-x-2">
        <button onclick="showTodayAvailability()" class="bg-blue-500 text-white px-3 py-2 rounded-lg font-semibold text-sm">
          <i class="fas fa-sun mr-1"></i>Today
        </button>
        <button onclick="showTomorrowAvailability()" class="bg-purple-500 text-white px-3 py-2 rounded-lg font-semibold text-sm">
          <i class="fas fa-calendar-plus mr-1"></i>Tomorrow
        </button>
        <button onclick="refreshAvailability()" class="bg-green-500 text-white px-3 py-2 rounded-lg font-semibold text-sm">
          <i class="fas fa-sync-alt mr-1"></i>Refresh
        </button>
      </div>
    </div>

    <!-- Availability Status -->
    <div id="availabilityStatus" class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
      <div class="flex flex-wrap items-center justify-between">
        <div class="flex items-center space-x-4">
          <span class="text-blue-700 font-medium">
            <i class="fas fa-info-circle mr-2"></i>
            <span id="availabilityText">Checking today's availability...</span>
          </span>
        </div>
        <div class="flex space-x-2 mt-2 sm:mt-0">
          <span class="availability-badge badge-available">üü¢ Available</span>
          <span class="availability-badge badge-booked">üî¥ Booked</span>
          <span class="availability-badge badge-partial">üü° Partial</span>
        </div>
      </div>
    </div>

    <!-- Venue-wise Availability Sections -->
    <div class="space-y-6">
      <!-- Auditorium Section -->
      <div class="venue-section">
        <div class="flex items-center mb-3">
          <i class="fas fa-theater-masks text-blue-500 text-xl mr-3"></i>
          <h3 class="text-lg font-bold text-gray-800">Auditorium Availability</h3>
        </div>
        <div id="auditoriumSlotsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
          <div class="text-center py-4 text-gray-500">
            <div class="loading-spinner mx-auto mb-2"></div>
            <p>Loading auditorium availability...</p>
          </div>
        </div>
      </div>

      <!-- Meeting Hall Section -->
      <div class="venue-section">
        <div class="flex items-center mb-3">
          <i class="fas fa-users text-purple-500 text-xl mr-3"></i>
          <h3 class="text-lg font-bold text-gray-800">Meeting Hall Availability</h3>
        </div>
        <div id="meetingSlotsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
          <div class="text-center py-4 text-gray-500">
            <div class="loading-spinner mx-auto mb-2"></div>
            <p>Loading meeting hall availability...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Request Modal -->
  <div id="requestModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeRequestModal()">&times;</span>
      <h2 class="text-2xl font-bold mb-4">üìã Request a Slot</h2>
      <form id="requestForm" class="space-y-4">
        <div>
          <label class="block text-gray-700 mb-2">Your Name:</label>
          <input type="text" id="requestName" required class="w-full border p-2 rounded" placeholder="Enter your full name" />
        </div>
        <div>
          <label class="block text-gray-700 mb-2">Department:</label>
          <input type="text" id="requestDepartment" required class="w-full border p-2 rounded" placeholder="Enter your department" />
        </div>
        <div>
          <label class="block text-gray-700 mb-2">Select Venue:</label>
          <select id="requestVenue" required class="w-full border p-2 rounded">
            <option value="Auditorium">Auditorium</option>
            <option value="Meeting Hall / Conference Room">Meeting Hall / Conference Room</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-700 mb-2">Preferred Date:</label>
          <input type="date" id="requestDate" required class="w-full border p-2 rounded" />
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-gray-700 mb-2">From Time:</label>
            <input type="time" id="requestTimeFrom" required class="w-full border p-2 rounded" min="08:00" max="16:00" />
          </div>
          <div>
            <label class="block text-gray-700 mb-2">To Time:</label>
            <input type="time" id="requestTimeTo" required class="w-full border p-2 rounded" min="08:00" max="16:00" />
          </div>
        </div>
        
        <!-- Availability Check in Modal -->
        <div id="modalAvailability" class="p-3 bg-gray-50 rounded-lg border hidden">
          <h4 class="font-semibold mb-2">üìä Selected Time Availability:</h4>
          <p id="availabilityResult" class="text-sm"></p>
        </div>
        
        <div class="flex space-x-3 pt-4">
          <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex-1">
            <i class="fas fa-paper-plane mr-2"></i>Submit Request
          </button>
          <button type="button" onclick="closeRequestModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 flex-1">
            Cancel
          </button>
        </div>
      </form>
      <p id="requestResponseMsg" class="mt-4 text-sm"></p>
    </div>
  </div>

  <!-- Reserved Slots Section -->
  <div class="glass-card p-4 md:p-6" id="printSection">
    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-4 md:mb-6 space-y-4 lg:space-y-0">
      <div class="text-center lg:text-left">
        <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800">üìÖ Reserved Slots</h2>
        <p class="text-gray-600 mt-1 text-sm md:text-base">All current bookings for Auditorium & Meeting Hall</p>
      </div>
      <div class="flex flex-wrap justify-center gap-2">
        <button onclick="showAllSlots()" class="btn-all text-white px-3 py-2 md:px-4 md:py-2 rounded-lg transition shadow-lg font-semibold text-sm md:text-base">
          <i class="fas fa-list mr-1 md:mr-2"></i>All
        </button>
        <button onclick="filterToday()" class="btn-today text-white px-3 py-2 md:px-4 md:py-2 rounded-lg transition shadow-lg font-semibold text-sm md:text-base">
          <i class="fas fa-sun mr-1 md:mr-2"></i>Today
        </button>
        <button onclick="filterAdvance()" class="btn-advance text-white px-3 py-2 md:px-4 md:py-2 rounded-lg transition shadow-lg font-semibold text-sm md:text-base">
          <i class="fas fa-calendar-plus mr-1 md:mr-2"></i>Advance
        </button>
        <button onclick="printSlots()" class="btn-print text-white px-3 py-2 md:px-4 md:py-2 rounded-lg transition shadow-lg font-semibold text-sm md:text-base">
          <i class="fas fa-print mr-1 md:mr-2"></i>Print
        </button>
        <button onclick="exportFirebaseData()" class="btn-export text-white px-3 py-2 md:px-4 md:py-2 rounded-lg transition shadow-lg font-semibold text-sm md:text-base">
          <i class="fas fa-download mr-1 md:mr-2"></i>Export
        </button>
      </div>
    </div>

    <!-- Filter Status -->
    <div id="filterStatus" class="mb-3 md:mb-4 p-2 md:p-3 bg-blue-50 rounded-lg border border-blue-200">
      <i class="fas fa-info-circle text-blue-500 mr-2"></i>
      <span id="statusText" class="text-blue-700 font-medium text-sm md:text-base">Showing all bookings</span>
    </div>

    <!-- Slots List -->
    <div id="slotList" class="space-y-3 md:space-y-4">
      <div class="text-center py-8 md:py-12 text-gray-500">
        <i class="fas fa-calendar-times text-4xl md:text-5xl mb-3 md:mb-4 text-gray-300"></i>
        <p class="text-base md:text-lg font-medium">No bookings found</p>
        <p class="text-xs md:text-sm mt-2">All slots are available for booking</p>
      </div>
    </div>
  </div>

  <!-- Firebase Integration -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, deleteDoc, doc,
      onSnapshot, orderBy, query, where, getDoc, setDoc, addDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // Firebase Config
    const firebaseConfigs = [
        {
            apiKey: "AIzaSyBQC1L-ixxvpDuzEDqn7YAuA0LC2DJIhSw",
            authDomain: "asms-10-09-25.firebaseapp.com",
            projectId: "asms-10-09-25",
            storageBucket: "asms-10-09-25.firebasestorage.app",
            messagingSenderId: "43340496311",
            appId: "1:43340496311:web:004e3c8b66f56abb5ffc32",
            measurementId: "G-9JHKMM7FM6"
        },
        {
            apiKey: "AIzaSyBQC1L-ixxvpDuzEDqn7YAuA0LC2DJIhSw",
            projectId: "asms-10-09-25"
        }
    ];

    let db;
    let currentApp;
    let firebaseInitialized = false;
    let currentAvailabilityDate = new Date().toISOString().split('T')[0];

    // Smart Firebase Initialization
    async function initializeFirebase() {
        for (let i = 0; i < firebaseConfigs.length; i++) {
            try {
                console.log(`üîÑ Trying Firebase config ${i + 1}...`);
                if (currentApp) {
                    try { await currentApp.delete(); } catch (e) {}
                }
                currentApp = initializeApp(firebaseConfigs[i], `app${i}`);
                db = getFirestore(currentApp);
                const testQuery = await getDocs(collection(db, "bookings"));
                console.log(`‚úÖ Firebase config ${i + 1} working! Found ${testQuery.size} bookings`);
                updateConnectionStatus("üü¢ Connected to Database - View Only Mode", "green");
                firebaseInitialized = true;
                return db;
            } catch (error) {
                console.log(`‚ùå Firebase config ${i + 1} failed:`, error.message);
            }
        }
        updateConnectionStatus("üî¥ Database Connection Failed", "red");
        throw new Error("All Firebase configs failed");
    }

    function updateConnectionStatus(message, color) {
        const statusElement = document.getElementById('connectionStatus');
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.style.color = color === 'green' ? '#10B981' : '#EF4444';
        }
    }

    async function initializeAppWithRetry() {
        try {
            await initializeFirebase();
            initializeAppComponents();
        } catch (error) {
            console.error("Failed to initialize:", error);
            setTimeout(initializeAppWithRetry, 5000);
        }
    }

    // User Management
    const ADMIN_CREDENTIALS = {
        username: "admin",
        password: "admin123"
    };

    // DOM Elements
    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const adminModal = document.getElementById('adminModal');
    const addUserForm = document.getElementById('addUserForm');
    const usersList = document.getElementById('usersList');
    const adminBtn = document.getElementById('adminBtn');

    function checkLoginStatus() {
        return localStorage.getItem('isLoggedIn') === 'true';
    }

    function showMainContent() {
        if (checkLoginStatus()) {
            loginModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            if (adminBtn) {
                adminBtn.style.display = isAdmin ? 'block' : 'none';
            }
        } else {
            loginModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
    }

    // Login Form Handler
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        try {
            if (!db) throw new Error("Database not connected");
            
            // Admin check
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('username', username);
                localStorage.setItem('isAdmin', 'true');
                showMainContent();
                initializeAppComponents();
                return;
            }
            
            // Firebase users check
            const snapshot = await getDocs(query(collection(db, "users"), 
                where("username", "==", username), 
                where("password", "==", password)));
            
            if (!snapshot.empty) {
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('username', username);
                localStorage.setItem('isAdmin', 'false');
                showMainContent();
                initializeAppComponents();
            } else {
                loginError.classList.remove('hidden');
                setTimeout(() => {
                    loginError.classList.add('hidden');
                }, 3000);
            }
            
        } catch (error) {
            console.error("Login error:", error);
            loginError.textContent = "Login error! Please try again.";
            loginError.classList.remove('hidden');
        }
    });

    // Open Admin Modal
    window.openAdminModal = async () => {
        const username = prompt("Admin Username:");
        const password = prompt("Admin Password:");
        
        if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
            adminModal.style.display = 'block';
            await loadUsersList();
        } else {
            alert("‚ùå Invalid admin credentials!");
        }
    };

    // Close Admin Modal
    window.closeAdminModal = () => {
        adminModal.style.display = 'none';
    };

    // Load Users from Firebase
    async function loadUsersList() {
        try {
            if (!db) return;
            
            const snapshot = await getDocs(collection(db, "users"));
            usersList.innerHTML = "";
            
            if (snapshot.empty) {
                usersList.innerHTML = '<p class="text-gray-500 text-center">No users found</p>';
                return;
            }
            
            snapshot.forEach(doc => {
                const user = doc.data();
                const userCard = document.createElement("div");
                userCard.className = "bg-gray-100 p-3 rounded-lg flex justify-between items-center";
                userCard.innerHTML = `
                    <div>
                        <strong>${user.username}</strong>
                        <p class="text-xs text-gray-600">Created: ${new Date(user.createdAt?.toDate()).toLocaleDateString()}</p>
                    </div>
                    <button onclick="deleteUser('${doc.id}')" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                usersList.appendChild(userCard);
            });
            
        } catch (error) {
            console.error("Error loading users:", error);
        }
    }

    // Add New User
    addUserForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const username = document.getElementById("newUsername").value.trim();
        const password = document.getElementById("newPassword").value.trim();
        
        if (!username || !password) {
            alert("‚ùå Please fill all fields!");
            return;
        }
        
        try {
            if (!db) throw new Error("Database not connected");
            
            const snapshot = await getDocs(query(collection(db, "users"), where("username", "==", username)));
            if (!snapshot.empty) {
                alert("‚ùå Username already exists!");
                return;
            }
            
            await addDoc(collection(db, "users"), {
                username: username,
                password: password,
                createdAt: new Date(),
                createdBy: "admin"
            });
            
            alert("‚úÖ User added successfully!");
            addUserForm.reset();
            await loadUsersList();
            
        } catch (error) {
            console.error("Error adding user:", error);
            alert("‚ùå Error adding user!");
        }
    });

    // Delete User
    window.deleteUser = async (userId) => {
        if (confirm("Are you sure you want to delete this user?")) {
            try {
                await deleteDoc(doc(db, "users", userId));
                await loadUsersList();
                alert("‚úÖ User deleted successfully!");
            } catch (error) {
                console.error("Error deleting user:", error);
                alert("‚ùå Error deleting user!");
            }
        }
    };

    // Logout Function
    window.logout = function() {
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('username');
        localStorage.removeItem('isAdmin');
        location.reload();
    };

    // Initialize login check on page load
    document.addEventListener('DOMContentLoaded', function() {
        showMainContent();
        initializeAppWithRetry();
    });

    // Initialize App Components
    function initializeAppComponents() {
        if (!checkLoginStatus()) return;
        
        loadLogo();
        setupLogoListener();
        showAllSlots();
        setupRealTimeListeners();
        showTodayAvailability();
    }

    // Network Detection & Auto-Recovery
    window.addEventListener('online', () => {
        console.log('üåê Internet connection restored');
        updateConnectionStatus("üü¢ Reconnecting...", "blue");
        if (!firebaseInitialized) {
            initializeAppWithRetry();
        }
    });

    window.addEventListener('offline', () => {
        console.log('‚ùå Internet connection lost');
        updateConnectionStatus("üî¥ No Internet Connection", "red");
    });

    setInterval(() => {
        if (navigator.onLine && !firebaseInitialized) {
            console.log('üîÑ Periodic connection check - reinitializing...');
            initializeAppWithRetry();
        }
    }, 30000);

    // DOM Elements
    const slotList = document.getElementById("slotList");
    const statusText = document.getElementById("statusText");
    const filterStatus = document.getElementById("filterStatus");
    const totalSlots = document.getElementById("totalSlots");
    const todaySlots = document.getElementById("todaySlots");
    const advanceSlots = document.getElementById("advanceSlots");
    const logoPreview = document.getElementById("logoPreview");
    const requestModal = document.getElementById("requestModal");
    const requestForm = document.getElementById("requestForm");
    const requestResponseMsg = document.getElementById("requestResponseMsg");
    const modalAvailability = document.getElementById("modalAvailability");
    const availabilityResult = document.getElementById("availabilityResult");

    let allBookings = [];
    let currentFilter = 'all';

    // ‚úÖ FIXED: Time Conversion Functions
    function formatTimeForDisplay(time24) {
        if (!time24) return '';
        
        // Agar already 12-hour format hai to wahi return karo
        if (time24.includes('AM') || time24.includes('PM')) {
            return time24;
        }
        
        // 24-hour format ko 12-hour mein convert karo
        const [hours, minutes] = time24.split(':').map(Number);
        const period = hours >= 12 ? 'PM' : 'AM';
        const hours12 = hours % 12 || 12;
        return `${hours12}:${minutes.toString().padStart(2, '0')} ${period}`;
    }

    function formatTimeForProcessing(time12) {
        if (!time12) return '';
        
        // Agar already 24-hour format hai to wahi return karo
        if (!time12.includes('AM') && !time12.includes('PM')) {
            return time12;
        }
        
        // 12-hour format ko 24-hour mein convert karo
        const [timePart, period] = time12.split(' ');
        let [hours, minutes] = timePart.split(':').map(Number);
        
        if (period === 'PM' && hours !== 12) {
            hours += 12;
        } else if (period === 'AM' && hours === 12) {
            hours = 0;
        }
        
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }

    function getActualTimeValue(timeInputId) {
        const input = document.getElementById(timeInputId);
        return input.value; // Browser hamesha 24-hour format mein value deta hai
    }

    // Modal Functions
    window.openRequestModal = () => {
        requestModal.style.display = 'block';
        const today = new Date().toISOString().split('T')[0];
        document.getElementById("requestDate").min = today;
        
        // Set default times
        document.getElementById("requestTimeFrom").value = "08:00";
        document.getElementById("requestTimeTo").value = "09:00";
        
        document.getElementById("requestVenue").addEventListener("change", function() {
            const selectedDate = document.getElementById("requestDate").value;
            if (selectedDate) {
                showAvailableTimesForDate(selectedDate);
            }
        });
        
        document.getElementById("requestDate").addEventListener("change", function(e) {
            showAvailableTimesForDate(e.target.value);
        });
        
        document.getElementById("requestTimeFrom").addEventListener("change", checkSelectedTimeAvailability);
        document.getElementById("requestTimeTo").addEventListener("change", checkSelectedTimeAvailability);
    };

    window.closeRequestModal = () => {
        requestModal.style.display = 'none';
        requestForm.reset();
        requestResponseMsg.textContent = '';
        modalAvailability.classList.add("hidden");
    };

    // Close modal when clicking outside
    window.onclick = (event) => {
        if (event.target === requestModal) {
            closeRequestModal();
        }
        if (event.target === adminModal) {
            closeAdminModal();
        }
    };

    // ‚úÖ FIXED: Check Time Availability Function
    async function checkTimeAvailability(date, timeFrom, timeTo, venue) {
        if (!db) return false;
        
        try {
            const snapshot = await getDocs(query(collection(db, "bookings"), 
                where("date", "==", date),
                where("venue", "==", venue)));
            
            const timeToMinutes = (time) => {
                const [h, m] = time.split(':').map(Number);
                return h * 60 + m;
            };
            
            const newStart = timeToMinutes(timeFrom);
            const newEnd = timeToMinutes(timeTo);
            
            let conflict = false;
            snapshot.forEach(docSnap => {
                const b = docSnap.data();
                const start = timeToMinutes(b.timeFrom);
                const end = timeToMinutes(b.timeTo);
                
                // Check for time overlap
                if (newStart < end && newEnd > start) {
                    conflict = true;
                }
            });
            
            return !conflict;
        } catch (error) {
            console.error("Time availability check error:", error);
            return false;
        }
    }

    // ‚úÖ FIXED: Check Selected Time Availability in Modal
    async function checkSelectedTimeAvailability() {
        const date = document.getElementById("requestDate").value;
        const timeFrom = getActualTimeValue("requestTimeFrom");
        const timeTo = getActualTimeValue("requestTimeTo");
        const venue = document.getElementById("requestVenue").value;
        
        console.log("üïí Time Check:", { 
            timeFrom, 
            timeTo, 
            venue,
            date 
        });
        
        if (!date || !timeFrom || !timeTo || !venue) {
            modalAvailability.classList.add("hidden");
            return;
        }
        
        try {
            const isAvailable = await checkTimeAvailability(date, timeFrom, timeTo, venue);
            
            // ‚úÖ FIXED: Use formatted time for display
            const displayFrom = formatTimeForDisplay(timeFrom);
            const displayTo = formatTimeForDisplay(timeTo);
            
            console.log("‚úÖ Availability Result:", { 
                isAvailable, 
                displayFrom, 
                displayTo 
            });
            
            if (isAvailable) {
                availabilityResult.innerHTML = `
                    <span class="text-green-600 font-semibold">üü¢ This time slot is AVAILABLE!</span>
                    <p class="text-sm mt-1 text-gray-600">You can proceed with booking ${venue} for ${displayFrom} - ${displayTo}</p>
                    <p class="text-xs mt-2 text-gray-500">Time in 24-hour: ${timeFrom} - ${timeTo}</p>
                `;
                modalAvailability.className = "p-3 bg-green-50 rounded-lg border border-green-200";
            } else {
                availabilityResult.innerHTML = `
                    <span class="text-red-600 font-semibold">üî¥ This time slot is already BOOKED!</span>
                    <p class="text-sm mt-1 text-gray-600">Please choose different time or venue</p>
                    <p class="text-xs mt-2 text-gray-500">Current selection: ${venue} | ${date} | ${displayFrom} - ${displayTo}</p>
                    <p class="text-xs mt-1 text-gray-500">24-hour format: ${timeFrom} - ${timeTo}</p>
                `;
                modalAvailability.className = "p-3 bg-red-50 rounded-lg border border-red-200";
            }
            
            modalAvailability.classList.remove("hidden");
        } catch (error) {
            console.error("Availability check error:", error);
            availabilityResult.innerHTML = `
                <span class="text-yellow-600 font-semibold">‚ö†Ô∏è Error checking availability</span>
                <p class="text-sm mt-1">Please try again</p>
            `;
            modalAvailability.className = "p-3 bg-yellow-50 rounded-lg border border-yellow-200";
            modalAvailability.classList.remove("hidden");
        }
    }

    // ‚úÖ FIXED: Submit Request Form with proper time handling
    requestForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = document.getElementById("requestName").value.trim();
        const department = document.getElementById("requestDepartment").value.trim();
        const venue = document.getElementById("requestVenue").value;
        const date = document.getElementById("requestDate").value;
        const timeFrom = getActualTimeValue("requestTimeFrom");
        const timeTo = getActualTimeValue("requestTimeTo");

        console.log("üìù Form Submission:", {
            name, department, venue, date, timeFrom, timeTo
        });

        if (!name || !department || !date || !timeFrom || !timeTo) {
            requestResponseMsg.textContent = "‚ùå Please fill all fields!";
            requestResponseMsg.className = "text-red-600";
            return;
        }

        // ‚úÖ FIXED: Time validation using 24-hour format
        const timeToMinutes = (time) => {
            const [h, m] = time.split(':').map(Number);
            return h * 60 + m;
        };

        const startMinutes = timeToMinutes(timeFrom);
        const endMinutes = timeToMinutes(timeTo);

        if (startMinutes >= endMinutes) {
            requestResponseMsg.textContent = "‚ùå 'To Time' must be after 'From Time'!";
            requestResponseMsg.className = "text-red-600";
            return;
        }

        // ‚úÖ FIXED: Working hours check (8AM-4PM = 480-960 minutes)
        if (startMinutes < 480 || endMinutes > 960) {
            requestResponseMsg.textContent = "‚ùå Booking allowed only between 8:00 AM - 4:00 PM";
            requestResponseMsg.className = "text-red-600";
            return;
        }

        // ‚úÖ FIXED: Final availability check before submission
        const isAvailable = await checkTimeAvailability(date, timeFrom, timeTo, venue);
        if (!isAvailable) {
            const displayFrom = formatTimeForDisplay(timeFrom);
            const displayTo = formatTimeForDisplay(timeTo);
            requestResponseMsg.textContent = `‚ùå ${displayFrom} - ${displayTo} time slot is already booked!`;
            requestResponseMsg.className = "text-red-600";
            return;
        }

        const dayName = new Date(date).toLocaleDateString("en-US", { weekday: "long" });

        try {
            if (!db) throw new Error("Database not connected");
            
            await addDoc(collection(db, "slotRequests"), {
                name,
                department,
                venue,
                date,
                day: dayName,
                timeFrom,
                timeTo,
                status: "pending",
                createdAt: new Date()
            });

            const displayFrom = formatTimeForDisplay(timeFrom);
            const displayTo = formatTimeForDisplay(timeTo);
            
            requestResponseMsg.textContent = `‚úÖ Request submitted for ${displayFrom} - ${displayTo}! We will contact you soon.`;
            requestResponseMsg.className = "text-green-600";
            
            setTimeout(() => {
                refreshAvailability();
            }, 500);
            
            setTimeout(() => {
                closeRequestModal();
            }, 2000);

        } catch (error) {
            console.error("Request submission error:", error);
            requestResponseMsg.textContent = "‚ùå Error submitting request. Please try again.";
            requestResponseMsg.className = "text-red-600";
        }
    });

    // Load logo from Firebase
    async function loadLogo() {
        try {
            if (!db) return;
            const logoDoc = await getDoc(doc(db, "settings", "logo"));
            if (logoDoc.exists()) {
                const logoData = logoDoc.data();
                if (logoData.logoUrl) {
                    logoPreview.src = logoData.logoUrl;
                }
            }
        } catch (error) {
            console.log("No logo found in database, using default");
            const savedLogo = localStorage.getItem("uploadedLogo");
            if (savedLogo) {
                logoPreview.src = savedLogo;
            }
        }
    }

    // Real-time logo listener
    function setupLogoListener() {
        if (!db) return;
        try {
            onSnapshot(doc(db, "settings", "logo"), (doc) => {
                if (doc.exists()) {
                    const logoData = doc.data();
                    if (logoData.logoUrl) {
                        logoPreview.src = logoData.logoUrl;
                        localStorage.setItem("uploadedLogo", logoData.logoUrl);
                    }
                }
            });
        } catch (error) {
            console.log("Logo listener setup failed:", error);
        }
    }

    // Setup Real-time Listeners
    function setupRealTimeListeners() {
        if (!db) return;
        try {
            const qAll = query(collection(db, "bookings"), orderBy("createdAt"));
            onSnapshot(qAll, (snapshot) => {
                const allData = [];
                snapshot.forEach(docSnap => {
                    allData.push({ id: docSnap.id, ...docSnap.data() });
                });

                // Refresh traffic light when bookings change
                if (currentAvailabilityDate) {
                    loadAvailabilityForDate(currentAvailabilityDate);
                } else {
                    showTodayAvailability();
                }

                if (currentFilter === 'all') {
                    renderList(allData);
                } else if (currentFilter === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    const todayData = allData.filter(booking => booking.date === today);
                    renderList(todayData);
                } else if (currentFilter === 'advance') {
                    const today = new Date().toISOString().split('T')[0];
                    const advanceData = allData.filter(booking => booking.date > today);
                    renderList(advanceData);
                }
            });

        } catch (error) {
            console.error("Real-time listener setup failed:", error);
        }
    }

    // Show Available Times when Date Selected
    async function showAvailableTimesForDate(selectedDate) {
        try {
            if (!db || !selectedDate) return;
            
            const selectedVenue = document.getElementById("requestVenue").value;
            
            if (!selectedVenue) {
                const availabilityDiv = document.getElementById('modalAvailability');
                const availabilityResult = document.getElementById('availabilityResult');
                
                availabilityResult.innerHTML = `
                    <span class="text-blue-600 font-semibold">Please select a venue first</span>
                    <p class="text-sm mt-1 text-gray-600">Choose Auditorium or Meeting Hall to see available slots</p>
                `;
                availabilityDiv.className = "p-3 bg-blue-50 rounded-lg border border-blue-200";
                availabilityDiv.classList.remove("hidden");
                return;
            }
            
            const snapshot = await getDocs(query(collection(db, "bookings"), 
                where("date", "==", selectedDate),
                where("venue", "==", selectedVenue)));
            
            const bookedSlots = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                bookedSlots.push({
                    start: data.timeFrom,
                    end: data.timeTo
                });
            });
            
            const availableSlots = calculateAvailableSlots(bookedSlots);
            displayAvailableSlots(availableSlots, selectedDate, selectedVenue);
            
        } catch (error) {
            console.error("Available times error:", error);
        }
    }

    // Calculate Available Slots between 8AM-4PM
    function calculateAvailableSlots(bookedSlots) {
        const workingStart = "08:00";
        const workingEnd = "16:00";
        
        bookedSlots.sort((a, b) => a.start.localeCompare(b.start));
        
        const availableSlots = [];
        let currentTime = workingStart;
        
        for (const booked of bookedSlots) {
            if (currentTime < booked.start) {
                availableSlots.push({
                    start: currentTime,
                    end: booked.start
                });
            }
            currentTime = booked.end > currentTime ? booked.end : currentTime;
        }
        
        if (currentTime < workingEnd) {
            availableSlots.push({
                start: currentTime,
                end: workingEnd
            });
        }
        
        return availableSlots;
    }

    // Display Available Slots in Modal
    function displayAvailableSlots(availableSlots, selectedDate, selectedVenue) {
        const availabilityDiv = document.getElementById('modalAvailability');
        const availabilityResult = document.getElementById('availabilityResult');
        
        if (availableSlots.length === 0) {
            availabilityResult.innerHTML = `
                <span class="text-red-600 font-semibold">üî¥ ${selectedVenue} Fully Booked!</span>
                <p class="text-sm mt-1">No available slots in ${selectedVenue} on ${selectedDate}</p>
                <p class="text-xs mt-2 text-gray-600">Try selecting the other venue or a different date</p>
            `;
            availabilityDiv.className = "p-3 bg-red-50 rounded-lg border border-red-200";
        } else {
            const slotsHTML = availableSlots.map(slot => {
                const displayStart = formatTimeForDisplay(slot.start);
                const displayEnd = formatTimeForDisplay(slot.end);
                return `
                    <div class="bg-green-100 border border-green-300 rounded p-2 mb-2">
                        <span class="text-green-700 font-semibold">üü¢ ${displayStart} - ${displayEnd}</span>
                    </div>
                `;
            }).join('');
            
            availabilityResult.innerHTML = `
                <span class="text-green-600 font-semibold">${selectedVenue} - Available Time Slots:</span>
                ${slotsHTML}
                <p class="text-sm mt-2 text-gray-600">Select any available time for your booking in ${selectedVenue}</p>
            `;
            availabilityDiv.className = "p-3 bg-green-50 rounded-lg border border-green-200";
        }
        
        availabilityDiv.classList.remove("hidden");
    }

    // Render bookings with beautiful UI
    function renderList(bookingsToShow) {
        slotList.innerHTML = "";
        allBookings = bookingsToShow;
        
        if (bookingsToShow.length === 0) {
            slotList.innerHTML = `
                <div class="text-center py-8 md:py-12 text-gray-500">
                    <i class="fas fa-calendar-times text-4xl md:text-5xl mb-3 md:mb-4 text-gray-300"></i>
                    <p class="text-base md:text-lg font-medium">No bookings found</p>
                    <p class="text-xs md:text-sm mt-2">All slots are available for booking</p>
                </div>
            `;
            updateStatistics();
            return;
        }

        bookingsToShow.forEach(booking => {
            const b = booking;
            const isToday = b.date === new Date().toISOString().split('T')[0];
            const badgeClass = isToday ? 'today-badge' : 'advance-badge';
            const badgeText = isToday ? 'TODAY' : 'ADVANCE';
            const venueIcon = b.venue === 'Auditorium' ? 'fas fa-theater-masks' : 'fas fa-users';
            const cardClass = b.venue === 'Auditorium' ? 'slot-card auditorium' : 'slot-card meeting';

            // ‚úÖ FIXED: Use formatted time for display
            const displayFrom = formatTimeForDisplay(b.timeFrom);
            const displayTo = formatTimeForDisplay(b.timeTo);

            const slotCard = document.createElement("div");
            slotCard.className = `${cardClass} rounded-lg p-3 md:p-5`;
            slotCard.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex flex-col sm:flex-row sm:items-center mb-2 md:mb-3 space-y-2 sm:space-y-0">
                            <div class="flex items-center">
                                <i class="${venueIcon} ${b.venue === 'Auditorium' ? 'text-blue-500' : 'text-purple-500'} mr-2 md:mr-3 text-lg md:text-xl"></i>
                                <h3 class="text-lg md:text-xl font-bold text-gray-800">${b.venue}</h3>
                            </div>
                            <span class="${badgeClass} text-xs font-bold px-2 md:px-3 py-1 rounded-full sm:ml-3 w-fit">${badgeText}</span>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-3 md:gap-4 mb-2 md:mb-3">
                            <div class="flex items-center text-gray-700">
                                <i class="fas fa-calendar-day mr-2 md:mr-3 text-blue-500 text-sm md:text-base"></i>
                                <span class="font-medium text-sm md:text-base">${b.date} (<span class="text-green-600">${b.day}</span>)</span>
                            </div>
                            <div class="flex items-center text-gray-700">
                                <i class="fas fa-clock mr-2 md:mr-3 text-green-500 text-sm md:text-base"></i>
                                <span class="font-medium text-sm md:text-base">${displayFrom} - ${displayTo}</span>
                            </div>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row sm:items-center text-gray-800 bg-gray-50 rounded-lg p-2 md:p-3 space-y-2 sm:space-y-0">
                            <div class="flex items-center">
                                <i class="fas fa-user mr-2 md:mr-3 text-purple-500"></i>
                                <span class="font-semibold text-gray-900 text-sm md:text-base">${b.name}</span>
                            </div>
                            <span class="hidden sm:inline mx-2 md:mx-3 text-gray-400">‚Ä¢</span>
                            <div class="flex items-center">
                                <i class="fas fa-building mr-2 text-gray-500"></i>
                                <span class="text-gray-700 text-sm md:text-base">${b.department}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            slotList.appendChild(slotCard);
        });

        updateStatistics();
    }

    // Update statistics
    function updateStatistics() {
        const today = new Date().toISOString().split('T')[0];
        const todayCount = allBookings.filter(b => b.date === today).length;
        const advanceCount = allBookings.filter(b => b.date > today).length;
        
        totalSlots.textContent = allBookings.length;
        todaySlots.textContent = todayCount;
        advanceSlots.textContent = advanceCount;
    }

    // TRAFFIC LIGHT SYSTEM FUNCTIONS

    // Calculate Available Hours
    function calculateAvailableHours(bookings, targetDate) {
        const workingHours = {
            start: "08:00",
            end: "16:00"
        };
        
        const dateBookings = bookings.filter(booking => booking.date === targetDate);
        
        if (dateBookings.length === 0) {
            return [{
                start: workingHours.start,
                end: workingHours.end,
                status: "available",
                duration: "8 hours"
            }];
        }
        
        const bookedSlots = dateBookings.map(b => ({
            start: b.timeFrom,
            end: b.timeTo
        })).sort((a, b) => a.start.localeCompare(b.start));
        
        const availableSlots = [];
        let currentTime = workingHours.start;
        
        for (let i = 0; i <= bookedSlots.length; i++) {
            if (i === 0 && currentTime < bookedSlots[i].start) {
                availableSlots.push({
                    start: currentTime,
                    end: bookedSlots[i].start,
                    status: "available"
                });
            }
            
            if (i === bookedSlots.length && currentTime < workingHours.end) {
                availableSlots.push({
                    start: currentTime,
                    end: workingHours.end,
                    status: "available"
                });
            }
            
            if (i > 0 && i < bookedSlots.length) {
                if (bookedSlots[i-1].end < bookedSlots[i].start) {
                    availableSlots.push({
                        start: bookedSlots[i-1].end,
                        end: bookedSlots[i].start,
                        status: "available"
                    });
                }
            }
            
            if (i < bookedSlots.length) {
                currentTime = bookedSlots[i].end;
            }
        }
        
        return availableSlots;
    }

    // Create Time Slot Cards - VENUE WISE
    function createTimeSlotCards(availableSlots, targetDate, venue) {
        const timeSlots = [
            { start: "08:00", end: "10:00", label: "Morning (8-10 AM)" },
            { start: "10:00", end: "12:00", label: "Late Morning (10 AM-12 PM)" },
            { start: "12:00", end: "14:00", label: "Afternoon (12-2 PM)" },
            { start: "14:00", end: "16:00", label: "Late Afternoon (2-4 PM)" }
        ];
        
        let totalAvailable = 0;
        let totalBooked = 0;
        
        const slotsHTML = timeSlots.map(slot => {
            const isAvailable = availableSlots.some(avail => 
                avail.start <= slot.start && avail.end >= slot.end
            );
            
            const isPartial = availableSlots.some(avail => 
                (avail.start <= slot.start && avail.end > slot.start) ||
                (avail.start < slot.end && avail.end >= slot.end)
            );
            
            let status, statusClass, statusText, icon;
            
            if (isAvailable) {
                status = "available";
                statusClass = "available";
                statusText = "üü¢ Fully Available";
                icon = "fa-check-circle";
                totalAvailable += 2;
            } else if (isPartial) {
                status = "partial";
                statusClass = "partial";
                statusText = "üü° Partially Booked";
                icon = "fa-exclamation-circle";
                totalAvailable += 1;
                totalBooked += 1;
            } else {
                status = "booked";
                statusClass = "booked";
                statusText = "üî¥ Fully Booked";
                icon = "fa-times-circle";
                totalBooked += 2;
            }
            
            return `
                <div class="time-slot ${statusClass}">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-bold text-sm">${slot.label}</h4>
                            <p class="text-xs">${slot.start} - ${slot.end}</p>
                        </div>
                        <i class="fas ${icon} ${status === 'available' ? 'text-green-500' : status === 'partial' ? 'text-yellow-500' : 'text-red-500'}"></i>
                    </div>
                    <div class="text-xs font-semibold">${statusText}</div>
                </div>
            `;
        }).join('');
        
        return { slotsHTML, totalAvailable, totalBooked };
    }

    // Show Today's Availability
    window.showTodayAvailability = async () => {
        try {
            if (!db) {
                alert("Database not connected. Please wait...");
                return;
            }
            
            currentAvailabilityDate = new Date().toISOString().split('T')[0];
            await loadAvailabilityForDate(currentAvailabilityDate);
            
        } catch (error) {
            console.error("Today availability error:", error);
            const auditoriumContainer = document.getElementById('auditoriumSlotsContainer');
            const meetingContainer = document.getElementById('meetingSlotsContainer');
            if (auditoriumContainer && meetingContainer) {
                auditoriumContainer.innerHTML = `
                    <div class="text-red-500 text-center py-4 col-span-4">
                        <p>Error loading availability</p>
                    </div>
                `;
                meetingContainer.innerHTML = `
                    <div class="text-red-500 text-center py-4 col-span-4">
                        <p>Error loading availability</p>
                    </div>
                `;
            }
        }
    };

    // Show Tomorrow's Availability
    window.showTomorrowAvailability = async () => {
        try {
            if (!db) {
                alert("Database not connected. Please wait...");
                return;
            }
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            currentAvailabilityDate = tomorrow.toISOString().split('T')[0];
            await loadAvailabilityForDate(currentAvailabilityDate);
            
        } catch (error) {
            console.error("Tomorrow availability error:", error);
            const auditoriumContainer = document.getElementById('auditoriumSlotsContainer');
            const meetingContainer = document.getElementById('meetingSlotsContainer');
            if (auditoriumContainer && meetingContainer) {
                auditoriumContainer.innerHTML = `
                    <div class="text-red-500 text-center py-4 col-span-4">
                        <p>Error loading availability</p>
                    </div>
                `;
                meetingContainer.innerHTML = `
                    <div class="text-red-500 text-center py-4 col-span-4">
                        <p>Error loading availability</p>
                    </div>
                `;
            }
        }
    };

    // Load Availability for Specific Date - VENUE WISE
    async function loadAvailabilityForDate(targetDate) {
        try {
            const auditoriumContainer = document.getElementById('auditoriumSlotsContainer');
            const meetingContainer = document.getElementById('meetingSlotsContainer');
            const availabilityText = document.getElementById('availabilityText');
            const availabilityStatus = document.getElementById('availabilityStatus');
            
            window.currentAvailabilityDate = targetDate;
            
            // Show loading
            auditoriumContainer.innerHTML = `
                <div class="text-center py-4 col-span-4 text-gray-500">
                    <div class="loading-spinner mx-auto mb-2"></div>
                    <p>Loading auditorium availability...</p>
                </div>
            `;
            meetingContainer.innerHTML = `
                <div class="text-center py-4 col-span-4 text-gray-500">
                    <div class="loading-spinner mx-auto mb-2"></div>
                    <p>Loading meeting hall availability...</p>
                </div>
            `;
            
            const snapshot = await getDocs(collection(db, "bookings"));
            const allBookings = [];
            snapshot.forEach(docSnap => {
                allBookings.push({ id: docSnap.id, ...docSnap.data() });
            });
            
            const auditoriumBookings = allBookings.filter(booking => 
                booking.venue === "Auditorium" && booking.date === targetDate
            );
            const meetingBookings = allBookings.filter(booking => 
                booking.venue === "Meeting Hall / Conference Room" && booking.date === targetDate
            );
            
            const auditoriumSlots = calculateAvailableHours(auditoriumBookings, targetDate);
            const meetingSlots = calculateAvailableHours(meetingBookings, targetDate);
            
            const auditoriumResult = createTimeSlotCards(auditoriumSlots, targetDate, "Auditorium");
            const meetingResult = createTimeSlotCards(meetingSlots, targetDate, "Meeting Hall");
            
            auditoriumContainer.innerHTML = auditoriumResult.slotsHTML;
            meetingContainer.innerHTML = meetingResult.slotsHTML;
            
            const dateObj = new Date(targetDate);
            const today = new Date().toISOString().split('T')[0];
            const isToday = targetDate === today;
            
            let dateText = isToday ? "Today" : dateObj.toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'short', 
                day: 'numeric' 
            });
            
            availabilityText.innerHTML = `
                <strong>${dateText}:</strong> 
                Auditorium: ${auditoriumResult.totalAvailable}/8 hours available | 
                Meeting Hall: ${meetingResult.totalAvailable}/8 hours available
            `;
            
            const totalAvailable = auditoriumResult.totalAvailable + meetingResult.totalAvailable;
            if (totalAvailable >= 12) {
                availabilityStatus.className = "mb-4 p-3 bg-green-50 rounded-lg border border-green-200";
            } else if (totalAvailable <= 4) {
                availabilityStatus.className = "mb-4 p-3 bg-red-50 rounded-lg border border-red-200";
            } else {
                availabilityStatus.className = "mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200";
            }
            
        } catch (error) {
            console.error("Load availability error:", error);
            
            const auditoriumContainer = document.getElementById('auditoriumSlotsContainer');
            const meetingContainer = document.getElementById('meetingSlotsContainer');
            
            if (auditoriumContainer && meetingContainer) {
                auditoriumContainer.innerHTML = `
                    <div class="text-red-500 text-center py-4 col-span-4">
                        <p>Error loading auditorium availability</p>
                    </div>
                `;
                meetingContainer.innerHTML = `
                    <div class="text-red-500 text-center py-4 col-span-4">
                        <p>Error loading meeting hall availability</p>
                    </div>
                `;
            }
        }
    }

    // Refresh Availability
    window.refreshAvailability = () => {
        if (currentAvailabilityDate) {
            loadAvailabilityForDate(currentAvailabilityDate);
        } else {
            showTodayAvailability();
        }
    };

    // Show all slots
    window.showAllSlots = async () => {
        try {
            if (!db) {
                alert("Database not connected. Please wait...");
                return;
            }
            currentFilter = 'all';
            statusText.textContent = "Showing all bookings (Today + Advance)";
            filterStatus.className = "mb-3 md:mb-4 p-2 md:p-3 bg-blue-50 rounded-lg border border-blue-200";
            const snapshot = await getDocs(query(collection(db, "bookings"), orderBy("createdAt")));
            const allData = [];
            snapshot.forEach(docSnap => {
                allData.push({ id: docSnap.id, ...docSnap.data() });
            });
            renderList(allData);
        } catch (error) {
            console.error("Error loading all slots:", error);
            alert("Error loading data. Please check connection.");
        }
    };

    // Export Firebase Data
    window.exportFirebaseData = async () => {
        try {
            if (!db) {
                alert("Database not connected. Please wait...");
                return;
            }
            
            slotList.innerHTML = '<div class="text-center py-4 text-gray-500"><div class="loading-spinner mx-auto mb-3"></div><p>Exporting data...</p></div>';
            
            const snapshot = await getDocs(collection(db, "bookings"));
            const bookingsData = [];
            
            snapshot.forEach(doc => {
                const data = doc.data();
                bookingsData.push({
                    id: doc.id,
                    name: data.name || '',
                    department: data.department || '',
                    venue: data.venue || '',
                    date: data.date || '',
                    day: data.day || '',
                    timeFrom: data.timeFrom || '',
                    timeTo: data.timeTo || '',
                    createdAt: data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate().toISOString() : data.createdAt) : ''
                });
            });
            
            const dataStr = JSON.stringify(bookingsData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `auditorium-bookings-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ ${bookingsData.length} bookings exported successfully!`);
            showAllSlots();
            
        } catch (error) {
            console.error("Export error:", error);
            alert("‚ùå Export failed: " + error.message);
            showAllSlots();
        }
    };

    // Filter today's bookings
    window.filterToday = async () => {
        try {
            if (!db) {
                alert("Database not connected. Please wait...");
                return;
            }
            currentFilter = 'today';
            const today = new Date().toISOString().split('T')[0];
            statusText.textContent = `Showing only today's bookings (${today})`;
            filterStatus.className = "mb-3 md:mb-4 p-2 md:p-3 bg-orange-50 rounded-lg border border-orange-200";
            const snapshot = await getDocs(query(collection(db, "bookings"), orderBy("createdAt")));
            const todayData = [];
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                if (data.date === today) {
                    todayData.push({ id: docSnap.id, ...data });
                }
            });
            renderList(todayData);
        } catch (error) {
            console.error("Error loading today's slots:", error);
            alert("Error loading data. Please check connection.");
        }
    };

    // Filter advance bookings
    window.filterAdvance = async () => {
        try {
            if (!db) {
                alert("Database not connected. Please wait...");
                return;
            }
            currentFilter = 'advance';
            const today = new Date().toISOString().split('T')[0];
            statusText.textContent = "Showing only advance bookings (Future dates)";
            filterStatus.className = "mb-3 md:mb-4 p-2 md:p-3 bg-green-50 rounded-lg border border-green-200";
            const snapshot = await getDocs(query(collection(db, "bookings"), orderBy("createdAt")));
            const advanceData = [];
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                if (data.date > today) {
                    advanceData.push({ id: docSnap.id, ...data });
                }
            });
            renderList(advanceData);
        } catch (error) {
            console.error("Error loading advance slots:", error);
            alert("Error loading data. Please check connection.");
        }
    };

    // Print slots
    window.printSlots = () => {
        if (allBookings.length === 0) {
            alert("No slots to print!");
            return;
        }
        window.print();
    };
  </script>

  <script>
    // Current Date
    const currentDate = new Date().toLocaleDateString('en-GB', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });
    document.getElementById('currentDate').textContent = `Today: ${currentDate}`;
  </script>
</body>
</html>